name: Test Build geosite
on:
  workflow_dispatch:
  push:
    branches:
      - test
    paths-ignore:
      - "README.md"
      - ".gitignore"
      - "LICENSE"

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codebase
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Build geosite.dat file
        run: go run ./ --outputdir=./

      - name: Install Mihomo (latest stable)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          gh release download -R MetaCubeX/mihomo --pattern 'mihomo-linux-amd64*.deb' --dir /tmp
          sudo apt install -y "$(ls -1 /tmp/mihomo-linux-amd64*.deb | head -n1)"
          rm -f /tmp/mihomo-linux-amd64*.deb

      - name: Build .mrs
        run: |
          set -euo pipefail

          work=/tmp/mihomo
          out="$work/rulesets"

          rm -rf "$work"
          mkdir -p "$out"
          cp -a ./data/. "$work"/

          find "$work" -path "$out" -prune -o -type f -print0 |
          while IFS= read -r -d '' f; do
            tmp="$(mktemp)"
            awk '
              function trim(s){ sub(/^[ \t]+/,"",s); sub(/[ \t]+$/,"",s); return s }
              {
                gsub(/\r/,"")
                s=$0

                sub(/[ \t]*#.*/, "", s)

                s=trim(s)
                gsub(/[ \t]+/, "", s)
                s=tolower(s)

                if (s == "") next

                if (s ~ /^full:/) {
                  sub(/^full:/, "", s)
                  if (s != "") print s
                  next
                }

                if (s ~ /^domain:/) {
                  sub(/^domain:/, "", s)
                  sub(/^\./, "", s)
                  if (s != "") print "+." s
                  next
                }

                if (s ~ /^[a-z0-9_-]+:/) next

                sub(/^\./, "", s)
                if (s != "") print "+." s
              }
            ' "$f" > "$tmp"

            rel="${f#$work/}"
            rel_noext="${rel%.*}"
            dest="$out/${rel_noext}.mrs"
            mkdir -p "$(dirname "$dest")"
            mihomo convert-ruleset domain text "$tmp" "$dest"
            rm -f "$tmp"
          done

      - name: Move files to publish directory
        run: |
          mkdir -p publish/mihomo
          cp ./geosite.dat publish/
          cp -a /tmp/mihomo/rulesets/. publish/mihomo/

      - name: Push artifacts to test-release branch
        env:
          BRANCH: test-release
        run: |
          set -euo pipefail

          stash=/tmp/test-release-artifacts
          rm -rf "$stash"
          mkdir -p "$stash"
          cp -a publish/. "$stash"/

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null; then
            git fetch --depth=1 origin "$BRANCH:$BRANCH"
            git switch "$BRANCH"
          else
            git switch --orphan "$BRANCH"
          fi

          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          cp -a "$stash"/. .

          git add -A
          git commit -m "Publish $(date -u +%Y%m%d%H%M)" --allow-empty
          git push origin HEAD:"$BRANCH"
